{% extends "base.html" %}

{% block title %}{% if content %}Editar{% else %}Novo{% endif %} Conteúdo - Discover Lisboa{% endblock %}

{% block content %}
<div class="container form-container">
    <h2 class="page-title">
        {% if content %}Editar Conteúdo{% else %}Criar Novo Conteúdo{% endif %}
    </h2>
    
    <form method="POST" enctype="multipart/form-data" class="content-form" id="contentForm">
        <div class="form-row">
            <div class="form-group">
                <label for="title">Título *</label>
                <input type="text" id="title" name="title" class="form-input" required
                       value="{{ content.title if content else '' }}"
                       placeholder="Nome do local">
            </div>
            
            <div class="form-group">
                <label for="category">Categoria *</label>
                <select id="category" name="category" class="form-input" required>
                    <option value="">Seleciona uma categoria</option>
                    <option value="restaurante" {% if content and content.category == 'restaurante' %}selected{% endif %}>Restaurante</option>
                    <option value="museu" {% if content and content.category == 'museu' %}selected{% endif %}>Museu</option>
                    <option value="monumento" {% if content and content.category == 'monumento' %}selected{% endif %}>Monumento</option>
                    <option value="miradouro" {% if content and content.category == 'miradouro' %}selected{% endif %}>Miradouro</option>
                    <option value="praia" {% if content and content.category == 'praia' %}selected{% endif %}>Praia</option>
                    <option value="jardim" {% if content and content.category == 'jardim' %}selected{% endif %}>Jardim</option>
                    <option value="outro" {% if content and content.category == 'outro' %}selected{% endif %}>Outro</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="description">Descrição *</label>
            <textarea id="description" name="description" class="form-input" required rows="4"
                      placeholder="Descreve o local...">{{ content.description if content else '' }}</textarea>
        </div>
        
        <!-- Pesquisa de Local -->
        <div class="form-group">
            <label for="location_search">Pesquisar Local</label>
            <div class="search-input-group">
                <input type="text" id="location_search" class="form-input" 
                       placeholder="Ex: Torre de Belém, Lisboa">
                <button type="button" class="btn-search" onclick="searchLocation()">Pesquisar</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>
        
        <!-- Campos GPS (preenchidos automaticamente) -->
        <div class="form-row">
            <div class="form-group">
                <label for="latitude">Latitude</label>
                <input type="number" id="latitude" name="latitude" class="form-input" 
                       step="0.0000001" value="{{ content.latitude if content else '' }}"
                       placeholder="38.xxxxx">
            </div>
            
            <div class="form-group">
                <label for="longitude">Longitude</label>
                <input type="number" id="longitude" name="longitude" class="form-input" 
                       step="0.0000001" value="{{ content.longitude if content else '' }}"
                       placeholder="-9.xxxxx">
            </div>
        </div>
        
        <div class="form-group">
            <label for="location_name">Nome do Local</label>
            <input type="text" id="location_name" name="location_name" class="form-input"
                   value="{{ content.location_name if content else '' }}"
                   placeholder="Nome completo do local">
        </div>
        
        <!-- Mini Mapa -->
        <div class="form-group">
            <label>Localização no Mapa</label>
            <div id="miniMap" class="mini-map"></div>
            <p class="form-hint">Clica no mapa para definir a localização</p>
        </div>
        
        <!-- Upload de Ficheiro -->
        <div class="form-group">
            <label for="media_file">Ficheiro Multimédia *{% if content %} (deixa em branco para manter o atual){% endif %}</label>
            <input type="file" id="media_file" name="media_file" class="form-input"
                   accept="image/*,video/*,audio/*" {% if not content %}required{% endif %}>
            <p class="form-hint">Formatos aceites: imagens (png, jpg, gif), vídeos (mp4, mov, avi), áudio (mp3, wav)</p>
            {% if content and content.media_filename %}
                <p class="form-hint">Ficheiro atual: {{ content.media_filename }}</p>
            {% endif %}
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-submit">
                {% if content %}Atualizar{% else %}Criar{% endif %} Conteúdo
            </button>
            <a href="{{ url_for('main.dashboard') }}" class="btn-cancel">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script>
    // Inicializar mini mapa
    const miniMap = L.map('miniMap').setView([38.7223, -9.1393], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(miniMap);
    
    let marker = null;
    
    // Se estiver a editar, adicionar marcador existente
    {% if content and content.latitude and content.longitude %}
        marker = L.marker([{{ content.latitude }}, {{ content.longitude }}]).addTo(miniMap);
        miniMap.setView([{{ content.latitude }}, {{ content.longitude }}], 15);
    {% endif %}
    
    // Clicar no mapa para definir localização
    miniMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng).addTo(miniMap);
        }
    });
    
    // Atualizar marcador quando coordenadas mudarem
    function updateMarker() {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(document.getElementById('longitude').value);
        
        if (lat && lng) {
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng]).addTo(miniMap);
            }
            miniMap.setView([lat, lng], 15);
        }
    }
</script>
{% endblock %}
